<div class="params-container">
  <h2>{{ meetingName || 'Race Parameters' }}</h2>

  <mat-card *ngIf="dataSource.length === 0" class="empty-state">
    <p>No selected races found. Please select a meeting in the Init page first.</p>
  </mat-card>

  <div *ngFor="let raceNum of getRaceNumbers()" class="race-section">
    <mat-card>
      <h3>Race {{ raceNum }}</h3>
      
      <table mat-table [dataSource]="getRaceData(raceNum)" class="params-table">
        
        <!-- Horse Number Column -->
        <ng-container matColumnDef="horseNum">
          <th mat-header-cell *matHeaderCellDef>Horse #</th>
          <td mat-cell *matCellDef="let row">
            <mat-form-field appearance="outline" class="small-field">
              <input matInput type="number" [(ngModel)]="row.horseNum" readonly>
            </mat-form-field>
          </td>
        </ng-container>

        <!-- Horse Name Column -->
        <ng-container matColumnDef="horseName">
          <th mat-header-cell *matHeaderCellDef>Horse Name</th>
          <td mat-cell *matCellDef="let row; let i = index">
            <mat-form-field appearance="outline" class="medium-field">
              <input matInput 
                     [(ngModel)]="row.horseName" 
                     [id]="'horseName-' + (dataSource.indexOf(row))"
                     (input)="onHorseNameInput(row)"
                     (keydown)="onHorseNameKeydown($event, dataSource.indexOf(row))"
                     placeholder="Enter horse name"
                     class="uppercase-input">
            </mat-form-field>
          </td>
        </ng-container>

        <!-- Special Date Column -->
        <ng-container matColumnDef="special">
          <th mat-header-cell *matHeaderCellDef>Special</th>
          <td mat-cell *matCellDef="let row; let i = index">
            <div class="datetime-container">
              <mat-form-field appearance="outline" class="date-field">
                <input matInput [matDatepicker]="specialPicker" [(ngModel)]="row.special" placeholder="Select date">
                <mat-datepicker-toggle matSuffix [for]="specialPicker"></mat-datepicker-toggle>
                <mat-datepicker #specialPicker></mat-datepicker>
              </mat-form-field>
              <mat-form-field appearance="outline" class="time-field">
                <input matInput type="time" [ngModel]="getTimeString(row.special)" 
                       (ngModelChange)="setTime(row, 'special', $event)" placeholder="Time">
              </mat-form-field>
              <button mat-icon-button (click)="clearDateTime(row, 'special')" 
                      *ngIf="row.special" 
                      class="clear-btn" 
                      title="Clear special date/time">
                ×
              </button>
            </div>
          </td>
        </ng-container>

        <!-- Rule4 Date Column -->
        <ng-container matColumnDef="rule4">
          <th mat-header-cell *matHeaderCellDef>Rule 4</th>
          <td mat-cell *matCellDef="let row; let i = index">
            <div class="datetime-container">
              <mat-form-field appearance="outline" class="date-field">
                <input matInput [matDatepicker]="rule4Picker" [(ngModel)]="row.rule4" placeholder="Select date">
                <mat-datepicker-toggle matSuffix [for]="rule4Picker"></mat-datepicker-toggle>
                <mat-datepicker #rule4Picker></mat-datepicker>
              </mat-form-field>
              <mat-form-field appearance="outline" class="time-field">
                <input matInput type="time" [ngModel]="getTimeString(row.rule4)" 
                       (ngModelChange)="setTime(row, 'rule4', $event)" placeholder="Time">
              </mat-form-field>
              <button mat-icon-button (click)="clearDateTime(row, 'rule4')" 
                      *ngIf="row.rule4" 
                      class="clear-btn" 
                      title="Clear rule4 date/time">
                ×
              </button>
            </div>
          </td>
        </ng-container>

        <!-- Rule4 Deduct Column -->
        <ng-container matColumnDef="rule4deduct">
          <th mat-header-cell *matHeaderCellDef>Rule 4 Deduct</th>
          <td mat-cell *matCellDef="let row">
            <mat-form-field appearance="outline" class="small-field">
              <input matInput type="number" [(ngModel)]="row.rule4deduct" placeholder="0">
            </mat-form-field>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['horseNum', 'horseName', 'special', 'rule4', 'rule4deduct']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['horseNum', 'horseName', 'special', 'rule4', 'rule4deduct'];"></tr>
      </table>
    </mat-card>
  </div>

  <!-- Save Button -->
  <div class="button-container" *ngIf="dataSource.length > 0">
    <button mat-raised-button color="primary" (click)="saveParams()">
      Save Parameters
    </button>
  </div>
</div>
