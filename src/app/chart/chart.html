<mat-sidenav-container class="chart-container">
  <mat-sidenav #sidenav position="end" mode="side" [style.width.px]="300">
    <div class="sidenav-content">
      <h3>Add Bet - Race {{ selectedRaceNum }}</h3>
      
      <div class="betslip-horses">
        @for (horse of betslipHorses; track horse.horseNum) {
          <button 
            mat-button 
            class="horse-button"
            [class.selected]="betslipSelectedHorseNum === horse.horseNum"
            [class.disabled]="horse.hasSpecial || horse.hasRule4"
            [disabled]="horse.hasSpecial || horse.hasRule4"
            (click)="selectBetslipHorse(horse.horseNum)">
            {{ horse.horseNum }} - {{ horse.horseName }}
            @if (horse.hasSpecial) { <span class="label">(Special)</span> }
            @if (horse.hasRule4) { <span class="label">(Rule4)</span> }
          </button>
        }
      </div>

      <div class="form-fields">
        <mat-form-field>
          <mat-label>Client Name</mat-label>
          <input matInput [(ngModel)]="clientName" (input)="onClientNameInput()" />
        </mat-form-field>

        <!-- Recent Clients -->
        <div *ngIf="recentClients.length > 0" style="display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 12px;">
          <button 
            *ngFor="let client of recentClients" 
            mat-stroked-button
            (click)="selectClient(client)"
            class="client-btn"
            style="font-size: 11px; padding: 0 8px; min-width: 0; height: 28px;">
            {{ client }}
          </button>
        </div>

        <mat-radio-group [(ngModel)]="betType">
          <mat-radio-button value="sales">Sales</mat-radio-button>
          <mat-radio-button value="purchase">Purchase</mat-radio-button>
        </mat-radio-group>

        <mat-radio-group [(ngModel)]="oddsType">
          <mat-radio-button value="f500">F500</mat-radio-button>
          <mat-radio-button value="odds">Odds</mat-radio-button>
        </mat-radio-group>

        <mat-form-field>
          <mat-label>Stake (Books)</mat-label>
          <input matInput type="number" [(ngModel)]="stakeBooks" 
                 (input)="validateStakeBooks()" 
                 (blur)="validateStakeBooks()" />
          <mat-error *ngIf="stakeBooksError">{{ stakeBooksError }}</mat-error>
        </mat-form-field>

        <mat-form-field>
          <mat-label>{{ oddsType === 'odds' ? 'Odds/100' : 'F500' }}</mat-label>
          <input matInput type="number" [(ngModel)]="odds" 
                 (input)="validateOdds()" 
                 (blur)="validateOdds()" />
          <mat-error *ngIf="oddsError">{{ oddsError }}</mat-error>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Tax %</mat-label>
          <input matInput type="number" [(ngModel)]="tax" />
        </mat-form-field>

        <button mat-raised-button color="primary" (click)="saveBet()">Save Bet</button>
      </div>
    </div>
  </mat-sidenav>

  <mat-sidenav-content>
    <!-- <h3 class="chart-title">Race Charts</h3> -->
    
    <div *ngIf="loading" class="loading">Loading data...</div>
    
    <div *ngIf="!loading && races.length === 0" class="no-data">
      No selected races found. Please select a meeting in the Init page first.
    </div>
    
    <div *ngIf="!loading && races.length > 0">
      @for (racePair of getRacePairs(); track $index) {
        <div class="race-pair">
          @for (race of racePair; track race.raceNum) {
            <div class="race-table-wrapper">
              <h4 class="race-title">Race {{ race.raceNum }}</h4>
              <table class="race-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Horse</th>
                    <th>Books</th>
                    <th>P&L</th>
                  </tr>
                </thead>
                <tbody>
                  @for (horse of race.horses; track horse.horseNum) {
                    <tr [ngClass]="{'winner-row': horse.isWinner, 'negative-profit': horse.profitLoss < 0 && !horse.isWinner}" 
                        (click)="openBetslip(race.raceNum, horse.horseNum)"
                        [style.cursor]="race.hasWinner ? 'not-allowed' : 'pointer'"
                        [style.opacity]="race.hasWinner && !horse.isWinner ? '0.6' : '1'">
                      <td>{{ horse.horseNum }}</td>
                      <td class="horse-name" [ngClass]="{'strikethrough': horse.hasSpecial || horse.hasRule4}">{{ horse.horseName }}</td>
                      <td class="books">{{ (horse.hasSpecial || horse.hasRule4) ? '-' : (horse.books | number:'1.0-0') }}</td>
                      <td class="profit-loss" [ngClass]="{
                        'positive': horse.profitLoss > 0,
                        'negative': horse.profitLoss < 0
                      }">{{ (horse.hasSpecial || horse.hasRule4) ? '-' : (horse.profitLoss | number:'1.0-0') }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      }
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>
