<mat-sidenav-container class="sidenav-container">
  <mat-sidenav #sidenav mode="over" position="end" class="betslip-sidenav">
    <div class="betslip-content">
      <h3>Betslip - Race {{ selectedRaceNum }}</h3>
      
      <div class="form-grid">
        <!-- Horse Selection -->
        <div class="full-width radio-group">
          <div class="horse-buttons">
            <button 
              *ngFor="let horse of betslipHorses" 
              mat-button
              [disabled]="horse.hasSpecial || horse.hasRule4"
              (click)="selectBetslipHorse(horse.horseNum)"
              class="horse-btn"
              [class.selected]="betslipSelectedHorseNum === horse.horseNum">
              {{ horse.horseNum }}
            </button>
          </div>
          <div class="horse-name-display">{{ betslipSelectedHorseName }}</div>
        </div>

        <!-- All Inputs in One Row -->
        <div class="full-width" style="display: flex; gap: 4px; flex-wrap: wrap;">
          <mat-form-field appearance="outline" style="flex: 1; min-width: 100px;">
            <mat-label>{{ oddsType === 'odds' ? 'Stakes' : 'Books' }}</mat-label>
            <input matInput type="number" [(ngModel)]="stakeBooks" 
                   (input)="validateStakeBooks()" 
                   (blur)="validateStakeBooks()">
            <mat-error *ngIf="stakeBooksError">{{ stakeBooksError }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" style="flex: 1; min-width: 80px;">
            <mat-label>{{ oddsType === 'odds' ? 'Odds' : 'F500' }}</mat-label>
            <input matInput type="number" [(ngModel)]="odds" 
                   (input)="validateOdds()" 
                   (blur)="validateOdds()">
            <mat-error *ngIf="oddsError">{{ oddsError }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" style="flex: 1.5; min-width: 80px;">
            <mat-label>Name</mat-label>
            <input matInput [(ngModel)]="clientName" (input)="onClientNameInput()">
          </mat-form-field>

          <mat-form-field appearance="outline" style="flex: 0.8; min-width: 60px;">
            <mat-label>Tax</mat-label>
            <input matInput type="number" [(ngModel)]="tax">
          </mat-form-field>
        </div>

        <!-- Recent Clients -->
        <div class="full-width" *ngIf="recentClients.length > 0" style="display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 8px;">
          <button 
            *ngFor="let client of recentClients" 
            mat-stroked-button
            (click)="selectClient(client)"
            class="client-btn"
            style="font-size: 11px; padding: 0 8px; min-width: 0; height: 28px;">
            {{ client }}
          </button>
        </div>

        <!-- Bet Option Selection -->
        <div class="full-width radio-group" style="display: flex; gap: 8px; flex-wrap: nowrap; align-items: center;">
          <mat-radio-group [(ngModel)]="betType" class="radio-buttons">
            <mat-radio-button value="sales">Sales</mat-radio-button>
            <mat-radio-button value="purchase">Pur</mat-radio-button>
          </mat-radio-group>
          <mat-radio-group [(ngModel)]="oddsType" class="radio-buttons">
            <mat-radio-button value="f500">F500</mat-radio-button>
            <mat-radio-button value="odds">Odds</mat-radio-button>
          </mat-radio-group>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="button-container">
        <button mat-raised-button color="primary" (click)="saveBet()" style="height: 64px; font-size: 1.5rem; min-width: 200px; background-color: #1976d2; color: white;">
          Save Bet
        </button>
        <button mat-raised-button (click)="sidenav.close()">
          Close
        </button>
      </div>
    </div>
  </mat-sidenav>

  <mat-sidenav-content>
    <div class="single-container">
      <!-- <h3 class="single-title">Race Chart</h3> -->
      
      <div *ngIf="loading && races.length === 0" class="loading">Loading data...</div>
      
      <div *ngIf="!loading && races.length === 0" class="no-data">
        No selected races found. Please select a meeting in the Init page first.
      </div>
      
      <div *ngIf="races.length > 0">
        <!-- Race Selection -->
        <div class="race-selection">
          <div class="race-buttons">
            <button 
              *ngFor="let race of races" 
              mat-button
              (click)="selectRace(race.raceNum)"
              class="race-btn"
              [class.selected]="selectedRaceNum === race.raceNum">
              {{ race.raceNum }}
            </button>
          </div>
        </div>
        
        <!-- Chart Display -->
        <div *ngIf="selectedRaceNum" class="chart-display">
          <div *ngIf="loading" class="loading">Loading race data...</div>
          
          <div *ngIf="!loading">
            <!-- <h4 class="race-title">Race {{ selectedRaceNum }}</h4> -->
            <div>
              <table class="race-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Horse ( {{ totalAvg | number:'1.0-0' }} )</th>
                    <th>Books</th>
                    <th>P&L</th>
                    <th>Avg</th>
                  </tr>
                </thead>
                <tbody>
                  @for (horse of horses; track horse.horseNum) {
                    <tr (click)="openBetslip(horse)" [style.cursor]="hasWinner ? 'not-allowed' : 'pointer'" [ngClass]="{'winner-row': horse.isWinner, 'disabled-row': hasWinner && !horse.isWinner, 'negative-profit': horse.profitLoss < 0 && !horse.isWinner}">
                      <td>{{ horse.horseNum }}</td>
                      <td class="horse-name" [ngClass]="{'strikethrough': horse.hasSpecial || horse.hasRule4}">{{ horse.horseName }}</td>
                      <td class="books">{{ (horse.hasSpecial || horse.hasRule4) ? '-' : (horse.books | number:'1.0-0') }}</td>
                      <td class="profit-loss" [ngClass]="{
                        'positive': horse.profitLoss > 0,
                        'negative': horse.profitLoss < 0
                      }">{{ (horse.hasSpecial || horse.hasRule4) ? '-' : (horse.profitLoss | number:'1.0-0') }}</td>
                      <td class="avg">{{ (horse.hasSpecial || horse.hasRule4) ? '-' : (horse.avg | number:'1.0-0') }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div *ngIf="!selectedRaceNum && !loading" class="select-prompt">
          Please select a race to view the chart.
        </div>
      </div>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>
