<div class="reports-container">
  <!-- <h2 class="reports-title">Client Reports</h2> -->
  <div>
    <button (click)="showSummaryOnly = !showSummaryOnly">
      {{ showSummaryOnly ? 'Show Details' : 'Show Summary' }}
    </button>
    <input
      type="text"
      placeholder="Filter by client name"
      [(ngModel)]="filterClientName"
    />
  </div>

  <table class="reports-table" *ngIf="!showSummaryOnly">
    <thead>
      <tr>
        <th>Client</th>
        <th>Date</th>
        <th>R</th>
        <th>H</th>
        <th>Horse Name</th>
        <th>Type</th>
        <th>Books</th>
        <th>F500</th>
        <th>Odds</th>
        <th>Stake</th>
        <th>Status</th>
        <th>Payout</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let clientName of filteredGroupedItems | keyvalue:compareKeysAsc; trackBy: trackClientKey; let isFirst = first">
        <ng-container *ngFor="let item of clientName.value; trackBy: trackItemId; let isFirstBet = first">
          <tr *ngIf="!item.cancelled" class="client-bet-row" [class.client-first-row]="isFirstBet && !isFirst">
            <td [ngClass]="{ 'pur-bet-type': (item.stake || 0) < 0 }">{{ clientName.key }}</td>
            <td [ngClass]="{ 'pur-bet-type': (item.stake || 0) < 0 }">
              {{ item.date | date:'dd/MM' }}<br>
              <small>{{ item.date | date:'HH:mm' }}</small>
            </td>
            <td [ngClass]="{ 'pur-bet-type': (item.stake || 0) < 0 }" style="text-align: center;">{{ item.raceNum }}</td>
            <td [ngClass]="{ 'pur-bet-type': (item.stake || 0) < 0 }" style="text-align: center;">{{ item.horseNum }}</td>
            <td [ngClass]="{ 'pur-bet-type': (item.stake || 0) < 0 }">
              {{ horseNamesByRace[item.raceNum - 1]?.[item.horseNum - 1] || '-' }}
              <small *ngIf="hasRule4Deduction(item) && !isRule4(item)" style="color: #dc2626; font-weight: 600;">
                {{ getRule4Deductions(item) }}
              </small>
            </td>
            <td [ngClass]="{ 'pur-bet-type': (item.stake || 0) < 0 }" style="text-align: center;">
              {{ (item.stake || 0) >= 0 ? 'S' : 'P' }}
            </td>
            <td [ngClass]="{ 'pur-bet-type': (item.stake || 0) < 0 }" style="text-align: right;">
              {{ item.f500 && item.f500 !== 0 ? (item.books | number:'1.0-0') : '-' }}
            </td>
            <td [ngClass]="{ 'pur-bet-type': (item.stake || 0) < 0 }" style="text-align: right;">
              {{ item.f500 && item.f500 !== 0 ? item.f500 : '-' }}
            </td>
            <td [ngClass]="{ 'pur-bet-type': (item.stake || 0) < 0 }" style="text-align: right;">
              {{ item.odds100 && item.odds100 !== 0 ? item.odds100 : '-' }}
            </td>
            <td [ngClass]="{
                'strike-stake': isSpecial(item) || isRule4(item),
                'pur-bet-type': (item.stake || 0) < 0
              }" style="text-align: right;">
              {{ item.stake | number:'1.0-0' }}
            </td>
            <td>
              <ng-container *ngIf="isSpecial(item)">
                <span class="withdrawn-label">With-Sp</span>
              </ng-container>
              <ng-container *ngIf="!isSpecial(item) && isRule4(item)">
                <span class="rule4-label">With-R4</span>
              </ng-container>
              <ng-container *ngIf="!isSpecial(item) && !isRule4(item) && hasRule4Deduction(item)">
                <span class="rule4-deduction-label">R4</span>
              </ng-container>
              <ng-container *ngIf="!isSpecial(item) && !isRule4(item) && !hasRule4Deduction(item) && isWinner(item)">
                <span class="winner-label">{{ isDeadHeat(item) ? 'Win-DH' : 'Win' }}</span>
              </ng-container>
            </td>
            <td style="text-align: right;">
              <ng-container *ngIf="isWinner(item)">
                <span class="payout-value-red">{{ getAdjustedPayout(item) | number:'1.0-0' }}</span>
              </ng-container>
            </td>
          </tr>
        </ng-container>
        <tr class="client-summary-row" *ngIf="hasActiveBets(clientName.value)">
            <td></td>
            <td></td>
            <td></td>
            <td></td>
          <td colspan="8" class="client-summary" style="text-align: left;">
            Stake: <span class="summary-value">{{ getStakeAmountForGroup(clientName.value) | number:'2.0-0' }}</span>
            &nbsp;|&nbsp;
            Tax: <span class="summary-value">{{ getTaxAmountForGroup(clientName.value) | number:'2.0-0' }}</span>
            &nbsp;|&nbsp;
            P/L: 
            <span 
              class="summary-value" 
              [ngClass]="{'negative-value': getProfitLossForGroup(clientName.value) < 0}">
              {{ getProfitLossForGroup(clientName.value) | number:'2.0-0' }}
            </span>
          </td>
        </tr>
      </ng-container>
    </tbody>
  </table>

  <table class="reports-table profit-table" *ngIf="showSummaryOnly">
    <thead>
      <tr>
        <th style="text-align: left;">Client</th>
        <th style="text-align: left;">Tax</th>
        <th style="text-align: left;">Collect</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let clientName of filteredGroupedItems | keyvalue:compareKeysAsc; trackBy: trackClientKey">
        <tr *ngIf="getProfitLossForGroup(clientName.value) > 0">
          <td style="text-align: left;">{{ clientName.key }}</td>
          <td style="text-align: left;">
            <span class="summary-value">
              {{ getTaxAmountForGroup(clientName.value) | number:'2.0-0' }}
            </span>
          </td>
          <td style="text-align: left;">
            <span class="summary-value">
              {{ getProfitLossForGroup(clientName.value) | number:'2.0-0' }}
            </span>
          </td>
        </tr>
      </ng-container>
      <tr>
        <td style="text-align: left; font-weight: 600;">Net Total:</td>
        <td style="text-align: left;">
          <span class="summary-value">
            {{ getNetTotalTaxAmount() | number:'2.0-0' }}
          </span>
        </td>
        <td style="text-align: left;">
          <span class="summary-value">
            {{ getNetTotalProfitLoss() > 0 ? (getNetTotalProfitLoss() | number:'2.0-0') : '0.00' }}
          </span>
        </td>
      </tr>
    </tbody>
  </table>

  <table class="reports-table loss-table" *ngIf="showSummaryOnly">
    <thead>
      <tr>
        <th style="text-align: left;">Client</th>
        <th style="text-align: left;">Tax</th>
        <th style="text-align: left;">Pay</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let clientName of filteredGroupedItems | keyvalue:compareKeysAsc; trackBy: trackClientKey">
        <tr *ngIf="getProfitLossForGroup(clientName.value) < 0">
          <td style="text-align: left;">{{ clientName.key }}</td>
          <td style="text-align: left;">
            <span class="summary-value">
              {{ getTaxAmountForGroup(clientName.value) | number:'2.0-0' }}
            </span>
          </td>
          <td style="text-align: left;">
            <span class="summary-value negative-value">
              {{ (getProfitLossForGroup(clientName.value) * -1) | number:'2.0-0' }}
            </span>
          </td>
        </tr>
      </ng-container>
      <tr>
        <td style="text-align: left; font-weight: 600;">Net Total:</td>
        <td style="text-align: left;">
          <span class="summary-value">
            {{ getNetTotalTaxAmountLoss() | number:'2.0-0' }}
          </span>
        </td>
        <td style="text-align: left;">
          <span class="summary-value negative-value">
            {{ getNetTotalLoss() | number:'2.0-0' }}
          </span>
        </td>
      </tr>
    </tbody>
  </table>

  <p>
    <strong>Net Profit:</strong>
    <span [ngClass]="{'negative-value': (getNetTotalProfitLoss() - getNetTotalLoss()) < 0}">
      {{ (getNetTotalProfitLoss() - getNetTotalLoss()) | number:'2.0-0' }}
    </span>
  </p>
  <button (click)="printProfit()">Print Report</button>

</div>


